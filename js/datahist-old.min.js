$(document).ready(function(){$("#highstock-container").hide();$("#options-container").hide();$("#collapseOne").collapse("show");var l={};l.spinnerOpts={lines:11,length:15,width:4,radius:10,corners:1,rotate:0,color:"#000",speed:1,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};l.spinnerTarget=document.getElementById("highstock-spinner");l.spinner=new Spinner(l.spinnerOpts).spin(l.spinnerTarget);l.navigatorseries={};l.numpoints=100;l.url="/logdata/2013-01-01T00:00:00Z/2015-01-01T00:00:01Z/"+l.numpoints+"?callback=?";l.data={};l.imageidx=0;l.series_enabled=["pressure"];l.xtemplate={};l.ychlorophyll={};l.yoxygen={};l.ysalinity={};l.yacoustic={};l.yturbidity={};l.yflowdir={};l.yflowmag={};l.ytemperature={};l.ypressure={};l.colours={pressure:"#009933",temperature:"#e81010",flowmag:"#0099cc",flowdir:"#6633cc",salinity:"#c71585",oxygen:"#ee6000",chlorophyll:"#808000",turbidity:"#a0522d",acoustic:"#707070"};l.jqc={};l.jqc.div={};l.jqc.div.pressure=$("#pressure-switch");l.jqc.div.temperature=$("#temperature-switch");l.jqc.div.flowmag=$("#flowmag-switch");l.jqc.div.flowdir=$("#flowdir-switch");l.jqc.div.turbidity=$("#turbidity-switch");l.jqc.div.acoustic=$("#acoustic-switch");l.jqc.div.salinity=$("#salinity-switch");l.jqc.div.oxygen=$("#oxygen-switch");l.jqc.div.chlorophyll=$("#chlorophyll-switch");l.jqc.cb={};l.jqc.cb.pressure=$("#checkboxPressure");l.jqc.cb.temperature=$("#checkboxTemperature");l.jqc.cb.flowmag=$("#checkboxFlow");l.jqc.cb.flowdir=$("#checkboxFlowDir");l.jqc.txt={};l.jqc.txt.togglehint=$("#toggle-group-hint");l.jqc.txt.togglehint.text("A maximum of four graphs can be displayed simultaneously");l.jqc.txt.togglehint.hide("fast");$("#pressure-switch span.switch-left").css("background-image","none");$("#pressure-switch span.switch-left").css("background-color",l.colours.pressure);$("#temperature-switch span.switch-left").css("background-image","none");$("#temperature-switch span.switch-left").css("background-color",l.colours.temperature);$("#flowmag-switch span.switch-left").css("background-image","none");$("#flowmag-switch span.switch-left").css("background-color",l.colours.flowmag);$("#flowdir-switch span.switch-left").css("background-image","none");$("#flowdir-switch span.switch-left").css("background-color",l.colours.flowdir);$("#chlorophyll-switch span.switch-left").css("background-image","none");$("#chlorophyll-switch span.switch-left").css("background-color",l.colours.chlorophyll);$("#turbidity-switch span.switch-left").css("background-image","none");$("#turbidity-switch span.switch-left").css("background-color",l.colours.turbidity);$("#oxygen-switch span.switch-left").css("background-image","none");$("#oxygen-switch span.switch-left").css("background-color",l.colours.oxygen);$("#acoustic-switch span.switch-left").css("background-image","none");$("#acoustic-switch span.switch-left").css("background-color",l.colours.acoustic);$("#salinity-switch span.switch-left").css("background-image","none");$("#salinity-switch span.switch-left").css("background-color",l.colours.salinity);(l.jqc.div.pressure).on("switch-change",a);(l.jqc.div.temperature).on("switch-change",a);(l.jqc.div.flowmag).on("switch-change",a);(l.jqc.div.flowdir).on("switch-change",a);(l.jqc.div.chlorophyll).on("switch-change",a);(l.jqc.div.turbidity).on("switch-change",a);(l.jqc.div.oxygen).on("switch-change",a);(l.jqc.div.acoustic).on("switch-change",a);(l.jqc.div.salinity).on("switch-change",a);function a(p,o){var q=$("#"+p.target.id).attr("sensor");if(o.value==true){if(l.series_enabled.length<4){if($.inArray(q,l.series_enabled)<0){l.series_enabled.push(q)}$("#drawgraphs").removeAttr("disabled")}else{(l.jqc.div[q]).bootstrapSwitch("setState",false);l.jqc.txt.togglehint.show("slow")}}else{if(l.series_enabled.length>0){l.series_enabled=$.grep(l.series_enabled,function(r){return r!=q});l.jqc.txt.togglehint.hide("slow")}if(l.series_enabled.length==0){$("#drawgraphs").attr("disabled","disabled")}}}$("#drawgraphs").click(function(){window.chart.destroy();$("#highstock-container").height(400+(l.series_enabled.length-1)*210);n()});function k(u){var v,o,t,s,r,q,p;v=u.getUTCMonth();v++;if(v<10){v="0"+v}o=u.getUTCDate();if(o<10){o="0"+o}t=u.getUTCFullYear();s=u.getUTCHours();if(s<10){s="0"+s}r=u.getUTCMinutes();if(r<10){r="0"+r}q=u.getUTCSeconds();if(q<10){q="0"+q}p=t+"-"+v+"-"+o+"T"+s+":"+r+":"+q+"Z";return p}function d(o){var r,p,q;r=o;r=r.replace(/\D/g," ");p=r.split(" ");p[1]--;q=new Date(Date.UTC(p[0],p[1],p[2],p[3],p[4],p[5]));return q}function i(q){var p=0,o=0;for(;p<l.data.time.length;p++){if(q<=l.data.time[p]){break}}if(p==0){o=0}else{if(Math.abs(l.data.time[p]-q)<Math.abs(l.data.time[p-1]-q)){o=p}else{o=p-1}}return o}function g(p,q){var o;l.datasetsInRange=p.datasets;dt=d(p.startdate);dt_ms=dt.getTime();l.data.time=p.seconds;for(o=0;o<l.data.time.length;o++){l.data.time[o]=dt_ms+l.data.time[o]*1000}l.data.phototime=p.photos;for(o=0;o<l.data.phototime.length;o++){l.data.phototime[o]=dt_ms+l.data.phototime[o]*1000}for(sensor in l.colours){l.data[sensor]=$.map(l.data.time,function(s,r){o=p[sensor][r]/100;if(sensor=="flowdir"&&o<80){o+=360}if(o<-100){return null}if(o>2000){return null}return[[s,o]]})}if(q!=null){setTimeout(q,0)}}$.getJSON(l.url,function(o){l.serverDatasets=o.datasets;g(o,null);l.navigatorseries=$.extend(true,[],l.data.pressure);setTimeout(n,0)});l.ypressure={labels:{formatter:function(){return this.value+" kPa"},style:{color:l.colours.pressure}},title:{text:"Pressure",style:{color:l.colours.pressure}},top:0,height:200,offset:0,lineColor:l.colours.pressure,lineWidth:1};l.ytemperature={title:{text:"Temperature",style:{color:l.colours.temperature}},labels:{formatter:function(){return this.value+"°C"},style:{color:l.colours.temperature}},top:0,height:200,offset:0,lineColor:l.colours.temperature,lineWidth:1};l.yflowmag={title:{text:"Flow Rate",style:{color:l.colours.flowmag}},labels:{formatter:function(){return this.value+" cm/s"},style:{color:l.colours.flowmag}},top:0,height:200,offset:0,lineColor:l.colours.flowmag,lineWidth:1};l.yflowdir={title:{text:"Flow Direction",style:{color:l.colours.flowdir}},labels:{formatter:function(){return this.value+"°"},style:{color:l.colours.flowdir}},top:0,height:200,offset:0,lineColor:l.colours.flowdir,lineWidth:1};l.yturbidity={title:{text:"Turbidity",style:{color:l.colours.turbidity}},labels:{formatter:function(){return this.value+" NTU"},style:{color:l.colours.turbidity}},top:0,height:200,offset:0,lineColor:l.colours.turbidity,lineWidth:1};l.yacoustic={title:{text:"Acoustic",style:{color:l.colours.acoustic}},labels:{formatter:function(){return this.value+" dB re. 1uPa@1m"},style:{color:l.colours.acoustic}},top:0,height:200,offset:0,lineColor:l.colours.acoustic,lineWidth:1};l.ysalinity={title:{text:"Salinity",style:{color:l.colours.salinity}},labels:{formatter:function(){return this.value+" PSU"},style:{color:l.colours.salinity}},top:0,height:200,offset:0,lineColor:l.colours.salinity,lineWidth:1};l.yoxygen={title:{text:"Oxygen",style:{color:l.colours.oxygen}},labels:{formatter:function(){return this.value+" uMol"},style:{color:l.colours.oxygen}},top:0,height:200,offset:0,lineColor:l.colours.oxygen,lineWidth:1};l.ychlorophyll={title:{text:"Chlorophyll",style:{color:l.colours.chlorophyll}},labels:{formatter:function(){return this.value+" ug/l"},style:{color:l.colours.chlorophyll}},top:0,height:200,offset:0,lineColor:l.colours.chlorophyll,lineWidth:1};l.xtemplate={id:"",name:"xtemplate",gapSize:4,color:l.colours.temperature,type:"line",yAxis:0,data:null,lineWidth:1,marker:{enabled:true,radius:2},tooltip:{valueDecimals:2,valueSuffix:"°C"},dataGrouping:{enabled:false}};function n(){var r,s,o,q,p;r="Click and drag to zoom in. Click on a data set to view the camera photo.";s=c();l.spinner.stop();$("#highstock-spinner").remove();$("#loadtext").remove();$("#highstock-container").show();$("#options-container").show();p=0;o=[];q=[];if($.inArray("pressure",l.series_enabled)>=0){q[p]=$.extend(true,[],l.xtemplate);q[p].data=l.data.pressure;q[p].yAxis=p;q[p].name="Pressure";q[p].tooltip.valueSuffix="<span>kPa</span>";q[p].color=l.colours.pressure;o[p++]=l.ypressure}if($.inArray("temperature",l.series_enabled)>=0){q[p]=$.extend(true,[],l.xtemplate);q[p].data=l.data.temperature;q[p].yAxis=p;q[p].name="Temperature";q[p].tooltip.valueSuffix="<span>°C</span>";q[p].color=l.colours.temperature;o[p++]=l.ytemperature}if($.inArray("flowmag",l.series_enabled)>=0){q[p]=$.extend(true,[],l.xtemplate);q[p].data=l.data.flowmag;q[p].yAxis=p;q[p].name="Flow Rate";q[p].tooltip.valueSuffix="<span>cm/s</span>";q[p].color=l.colours.flowmag;o[p++]=l.yflowmag}if($.inArray("flowdir",l.series_enabled)>=0){q[p]=$.extend(true,[],l.xtemplate);q[p].data=l.data.flowdir;q[p].yAxis=p;q[p].name="Flow Direction";q[p].tooltip.valueSuffix="<span>° re. mag. North</span>";q[p].color=l.colours.flowdir;o[p++]=l.yflowdir}if($.inArray("turbidity",l.series_enabled)>=0){q[p]=$.extend(true,[],l.xtemplate);q[p].data=l.data.turbidity;q[p].yAxis=p;q[p].name="Turbidity";q[p].tooltip.valueSuffix="<span>NTU</span>";q[p].color=l.colours.turbidity;o[p++]=l.yturbidity}if($.inArray("acoustic",l.series_enabled)>=0){q[p]=$.extend(true,[],l.xtemplate);q[p].data=l.data.acoustic;q[p].yAxis=p;q[p].name="Acoustic";q[p].tooltip.valueSuffix="<span>dB re. 1uPa@1m</span>";q[p].color=l.colours.acoustic;o[p++]=l.yacoustic}if($.inArray("salinity",l.series_enabled)>=0){q[p]=$.extend(true,[],l.xtemplate);q[p].data=l.data.salinity;q[p].yAxis=p;q[p].name="Salinity";q[p].tooltip.valueSuffix="<span>PSU</span>";q[p].color=l.colours.salinity;o[p++]=l.ysalinity}if($.inArray("oxygen",l.series_enabled)>=0){q[p]=$.extend(true,[],l.xtemplate);q[p].data=l.data.oxygen;q[p].yAxis=p;q[p].name="Oxygen";q[p].tooltip.valueSuffix="<span>uMol</span>";q[p].color=l.colours.oxygen;o[p++]=l.yoxygen}if($.inArray("chlorophyll",l.series_enabled)>=0){q[p]=$.extend(true,[],l.xtemplate);q[p].data=l.data.chlorophyll;q[p].yAxis=p;q[p].name="Chlorophyll";q[p].tooltip.valueSuffix="<span>ug/l</span>";q[p].color=l.colours.chlorophyll;o[p++]=l.ychlorophyll}o[0].top=90;for(j=1;j<p;j++){o[j].top=210*j+90}window.chart=new Highcharts.StockChart({chart:{events:{click:function(t){e(t.xAxis[0].value)}},renderTo:"highstock-container",zoomType:"x"},plotOptions:{series:{point:{events:{click:function(t){e(this.category)}}}}},navigator:{adaptToUpdatedData:false,series:{data:l.navigatorseries}},title:{text:r},subtitle:{text:s},credits:{enabled:false},rangeSelector:{buttons:[{type:"hour",count:1,text:"1h"},{type:"day",count:1,text:"1d"},{type:"month",count:1,text:"1m"},{type:"all",text:"All"}],inputEnabled:false,selected:3},tooltip:{xDateFormat:"%A, %b %d, %H:%M:%S UTC",headerFormat:'<span style="font-size: 12px">{point.key}</span><br/>',},yAxis:o,xAxis:{ordinal:false,events:{afterSetExtremes:m},minRange:60*60*1000},series:q})}function m(p){var o="/logdata/"+k(new Date(p.min))+"/"+k(new Date(p.max))+"/"+l.numpoints+"?callback=?";chart.showLoading("Loading data from server...");$.getJSON(o,function(q){g(q,h)})}function h(){var o=0;if($.inArray("pressure",l.series_enabled)>=0){chart.series[o++].setData(l.data.pressure)}if($.inArray("temperature",l.series_enabled)>=0){chart.series[o++].setData(l.data.temperature)}if($.inArray("flowmag",l.series_enabled)>=0){chart.series[o++].setData(l.data.flowmag)}if($.inArray("flowdir",l.series_enabled)>=0){chart.series[o++].setData(l.data.flowdir)}if($.inArray("turbidity",l.series_enabled)>=0){chart.series[o++].setData(l.data.turbidity)}if($.inArray("acoustic",l.series_enabled)>=0){chart.series[o++].setData(l.data.acoustic)}if($.inArray("salinity",l.series_enabled)>=0){chart.series[o++].setData(l.data.salinity)}if($.inArray("oxygen",l.series_enabled)>=0){chart.series[o++].setData(l.data.oxygen)}if($.inArray("chlorophyll",l.series_enabled)>=0){chart.series[o++].setData(l.data.chlorophyll)}chart.setTitle(null,{text:c()});chart.hideLoading()}function c(){zoom=Math.floor(100*l.data.pressure.length/l.datasetsInRange);var o="";if(zoom<1){zoom=1;o="<"}return"Displaying "+l.data.pressure.length+" ("+o+zoom+"%) of "+l.datasetsInRange+" datasets available for this time range"}function b(o){var q,r,p,s;q=l.data.phototime[o];datastamp=l.data.time[o];if(Math.abs(q)<(1370304000*1000)){$("#myModalTitle").text("Sorry, photos are only available after the 4th of June, 2013.");$("#dsetphoto").attr("src","img/camera_image_not_available.jpg");return}if(Math.abs(q-datastamp)>(1800*1000)){$("#myModalTitle").text("Sorry, the photo for this dataset is not available");$("#dsetphoto").attr("src","img/camera_image_not_available.jpg");return}r=Highcharts.dateFormat("SmallImage--%Y-%m-%d--%H-%M-%S--UTC.jpg",q);p=Highcharts.dateFormat("%Y-%m-%d %H:%M:%S GMT",q);$("#myModalTitle").text("Loading photo for "+p);s=new Image();s.src="/image/"+r;if(s.complete){$("#dsetphoto").attr("src",s.src);$("#myModalTitle").text("Photo taken "+p)}else{s.onerror=function(){$("#myModalTitle").text("Sorry, the photo for this dataset is not available");$("#dsetphoto").attr("src","img/camera_image_not_available.jpg")};s.onload=function(){if((this.src).indexOf("not_available")>=0){$("#myModalTitle").text("Sorry, that dataset photo is not available")}else{$("#myModalTitle").text("Photo taken "+p)}$("#dsetphoto").attr("src",this.src)}}}function e(o){$("#myModalTitle").text("Loading image");$("#dsetphoto").attr("src","img/camera_image_loading.jpg");$("#myModal").modal("show");$("#btn-previous").removeAttr("disabled");$("#btn-next").removeAttr("disabled");l.imageidx=i(o);b(l.imageidx)}function f(o){if(o<=0){o=0;$("#btn-previous").attr("disabled","disabled")}else{if(o==1){$("#btn-previous").removeAttr("disabled")}}var p=l.data.phototime.length-1;if(o>=p){o=p;$("#btn-next").attr("disabled","disabled")}else{if(o==p-1){$("#btn-next").removeAttr("disabled")}}b(o)}$("#btn-next").click(function(){l.imageidx=l.imageidx+1;f(l.imageidx)});$("#btn-previous").click(function(){l.imageidx=l.imageidx-1;f(l.imageidx)})});